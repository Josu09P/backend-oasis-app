name: CI/CD Decor House ğŸ 

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_PROJECT_NAME: 'decor-house'
  APP_CONTAINER_NAME: 'decor-house-app'
  DB_CONTAINER_NAME: 'mysql-decor-house-prod'
  DB_NAME: 'decor_house_prod'
  DB_USER: 'root'
  DB_PASSWORD: 'admin123'
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_HOST_URL: 'http://sonarqube:9000'

jobs:
  build-test-sonar-docker:
    name: Build, Test, Sonar y Docker
    runs-on: self-hosted

    steps:
      - name: ğŸ”„ Checkout del repositorio
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ“¦ Compilar el proyecto (sin tests)
        run: mvn clean package -DskipTests

      - name: â³ Esperar a que SonarQube estÃ© disponible
        run: |
          echo "â³ Esperando que SonarQube estÃ© listo..."
          for i in {1..10}; do
            if curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/health > /dev/null; then
              echo "âœ… SonarQube estÃ¡ disponible"
              break
            fi
            echo "ğŸ” Intento $i: SonarQube aÃºn no responde, esperando 5 segundos..."
            sleep 5
          done

      - name: ğŸ” AnÃ¡lisis estÃ¡tico con SonarQube
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=decor-house \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }}

      - name: ğŸ³ Despliegue con Docker Compose
        run: |
          echo "ğŸ§¹ Limpiando contenedores anteriores..."
          cd docker

          docker compose -p $DOCKER_PROJECT_NAME down -v --remove-orphans || echo "Nada que bajar"

          echo "ğŸ—ï¸ Construyendo imÃ¡genes e iniciando servicios..."
          docker compose -p $DOCKER_PROJECT_NAME up -d --build

          echo "â³ Esperando que la base de datos estÃ© lista..."
          sleep 30

          echo "ğŸ’¾ Ejecutando script SQL de inicializaciÃ³n..."
          cat ../sql/init.sql | docker exec -i $DB_CONTAINER_NAME mysql -u$DB_USER -p$DB_PASSWORD $DB_NAME

          echo "ğŸ” Estado actual de los contenedores:"
          docker compose -p $DOCKER_PROJECT_NAME ps

          echo "ğŸ“„ Logs recientes de la app:"
          docker logs --tail 100 $APP_CONTAINER_NAME

      - name: âœ… Validar estado del backend
        run: |
          echo "ğŸ” Verificando salud de la aplicaciÃ³n en http://localhost:8084/actuator/health"
          sleep 10
          curl --fail http://localhost:8084/actuator/health || (echo "âŒ Backend no estÃ¡ saludable" && exit 1)
