name: CI/CD Decor House 🏠

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

env:
  DOCKER_PROJECT_NAME: 'decor-house'
  APP_CONTAINER_NAME: 'decor-house-app'
  DB_CONTAINER_NAME: 'mysql-decor-house-prod'
  DB_NAME: 'decor_house_prod'
  DB_USER: 'root'
  DB_PASSWORD: 'admin123'
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_HOST_URL: 'http://localhost:9000'

jobs:
  build-test-sonar-docker:
    runs-on: self-hosted

    steps:
      - name: 🔄 Checkout del repositorio
        uses: actions/checkout@v4

      - name: ☕ Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 🐳 Desplegar base de datos MySQL
        run: |
          cd docker
          echo "🧼 Limpiando base de datos previa..."
          docker compose -p $DOCKER_PROJECT_NAME down -v --remove-orphans || echo "Nada que bajar"

          echo "🏗️ Levantando solo la DB..."
          docker compose -p $DOCKER_PROJECT_NAME up -d db

          echo "⏳ Esperando a que MySQL esté listo..."
          sleep 30

          echo "💾 Ejecutando script SQL..."
          cat ../sql/init.sql | docker exec -i $DB_CONTAINER_NAME mysql -u$DB_USER -p$DB_PASSWORD $DB_NAME

      - name: 📦 Build y Tests con Maven
        run: mvn -B clean verify

      - name: 🔍 Análisis con SonarQube
        run: mvn sonar:sonar -Dsonar.projectKey=decor-house \
                             -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
                             -Dsonar.login=${{ env.SONAR_TOKEN }}

      - name: 🐳 Desplegar app (servicio completo)
        run: |
          echo "🧼 Deteniendo todo nuevamente para redeploy..."
          cd docker
          docker compose -p $DOCKER_PROJECT_NAME down -v --remove-orphans

          echo "🚀 Levantando servicios completos..."
          docker compose -p $DOCKER_PROJECT_NAME up -d --build

          echo "📄 Logs de la app:"
          docker logs --tail 100 $APP_CONTAINER_NAME
